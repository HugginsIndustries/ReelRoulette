<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ReelRoulette"
        x:Class="ReelRoulette.FilterDialog"
        x:DataType="local:FilterDialog"
        Title="Filter Media"
        Width="1200"
        Height="800"
        WindowStartupLocation="Manual"
        MinWidth="500"
        MinHeight="500">
    <Grid RowDefinitions="Auto * Auto" Margin="12">
        <!-- Header -->
        <TextBlock Grid.Row="0" 
                   x:Name="HeaderTextBlock"
                   Text="{Binding HeaderText}"
                   FontWeight="Bold"
                   FontSize="16"
                   Margin="0,0,0,16"/>

        <!-- Content -->
        <TabControl Grid.Row="1" 
                    Margin="0,0,0,16">
            <!-- General Tab -->
            <TabItem Header="General">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16" Margin="12">
                        <!-- Basic Flags Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Basic Filters" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <CheckBox x:Name="FavoritesOnlyCheckBox"
                                      Content="Favorites only"
                                      IsChecked="{Binding FavoritesOnly}"/>
                            <CheckBox x:Name="ExcludeBlacklistedCheckBox"
                                      Content="Exclude blacklisted"
                                      IsChecked="{Binding ExcludeBlacklisted}"/>
                            <CheckBox x:Name="OnlyNeverPlayedCheckBox"
                                      Content="Only never played"
                                      IsChecked="{Binding OnlyNeverPlayed}"/>
                            <CheckBox x:Name="OnlyKnownDurationCheckBox"
                                      Content="Only videos with known duration"
                                      IsChecked="{Binding OnlyKnownDuration}"/>
                            <CheckBox x:Name="OnlyKnownLoudnessCheckBox"
                                      Content="Only videos with known loudness"
                                      IsChecked="{Binding OnlyKnownLoudness}"/>
                        </StackPanel>

                        <!-- Media Type Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Media Type" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <RadioButton x:Name="MediaTypeAllRadio"
                                         Content="All (Videos and Photos)"
                                         GroupName="MediaType"
                                         IsChecked="{Binding MediaTypeAll}"/>
                            <RadioButton x:Name="MediaTypeVideosOnlyRadio"
                                         Content="Videos only"
                                         GroupName="MediaType"
                                         IsChecked="{Binding MediaTypeVideosOnly}"/>
                            <RadioButton x:Name="MediaTypePhotosOnlyRadio"
                                         Content="Photos only"
                                         GroupName="MediaType"
                                         IsChecked="{Binding MediaTypePhotosOnly}"/>
                        </StackPanel>

                        <!-- Audio Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Audio Filter" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <RadioButton x:Name="AudioFilterAllRadio"
                                         Content="All videos"
                                         GroupName="AudioFilter"
                                         IsChecked="{Binding AudioFilterAll}"/>
                            <RadioButton x:Name="AudioFilterWithAudioRadio"
                                         Content="Only videos with audio"
                                         GroupName="AudioFilter"
                                         IsChecked="{Binding AudioFilterWithAudio}"/>
                            <RadioButton x:Name="AudioFilterWithoutAudioRadio"
                                         Content="Only videos without audio"
                                         GroupName="AudioFilter"
                                         IsChecked="{Binding AudioFilterWithoutAudio}"/>
                        </StackPanel>

                        <!-- Duration Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Duration Filter" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <Grid ColumnDefinitions="Auto * Auto" ColumnSpacing="8">
                                <TextBlock Grid.Column="0" 
                                           Text="Min:" 
                                           VerticalAlignment="Center"
                                           MinWidth="50"/>
                                <TextBox x:Name="MinDurationTextBox"
                                         Grid.Column="1"
                                         Watermark="HH:MM:SS or leave empty"
                                         Text="{Binding MinDurationText}"/>
                                <CheckBox x:Name="NoMinDurationCheckBox"
                                          Grid.Column="2"
                                          Content="No minimum"
                                          IsChecked="{Binding NoMinDuration}"
                                          VerticalAlignment="Center"/>
                            </Grid>
                            <Grid ColumnDefinitions="Auto * Auto" ColumnSpacing="8">
                                <TextBlock Grid.Column="0" 
                                           Text="Max:" 
                                           VerticalAlignment="Center"
                                           MinWidth="50"/>
                                <TextBox x:Name="MaxDurationTextBox"
                                         Grid.Column="1"
                                         Watermark="HH:MM:SS or leave empty"
                                         Text="{Binding MaxDurationText}"/>
                                <CheckBox x:Name="NoMaxDurationCheckBox"
                                          Grid.Column="2"
                                          Content="No maximum"
                                          IsChecked="{Binding NoMaxDuration}"
                                          VerticalAlignment="Center"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Tags Tab -->
            <TabItem Header="Tags">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16" Margin="12">
                        <!-- Legacy Match Mode (hidden, kept for old presets) -->
                        <StackPanel Spacing="8" IsVisible="False">
                            <StackPanel Orientation="Horizontal" 
                                        Spacing="8">
                                <TextBlock Text="Match mode:" 
                                           VerticalAlignment="Center"/>
                                <RadioButton x:Name="TagMatchAndRadio"
                                             Content="All selected (AND)"
                                             GroupName="TagMatch"
                                             IsChecked="{Binding TagMatchAnd}"/>
                                <RadioButton x:Name="TagMatchOrRadio"
                                             Content="Any selected (OR)"
                                             GroupName="TagMatch"
                                             IsChecked="{Binding TagMatchOr}"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Global Match Mode -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Category Combination" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Combine categories using:" 
                                           VerticalAlignment="Center"/>
                                <ComboBox x:Name="GlobalMatchModeComboBox"
                                          Width="120"
                                          SelectionChanged="GlobalMatchMode_SelectionChanged">
                                    <ComboBoxItem Content="AND" Tag="True"/>
                                    <ComboBoxItem Content="OR" Tag="False"/>
                                </ComboBox>
                            </StackPanel>
                            <TextBlock Text="AND = must match all categories. OR = match any category."
                                      FontSize="11"
                                      Opacity="0.7"
                                      TextWrapping="Wrap"
                                      Margin="0,0,0,8"/>
                        </StackPanel>

                        <!-- Tags by Category -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Tags Filter" 
                                       FontWeight="SemiBold" 
                                       FontSize="13"
                                       Margin="0,0,0,4"/>
                            <TextBlock x:Name="NoTagsTextBlock"
                                       Text="No tags available. Use Library → Manage Tags to create tags."
                                       Foreground="Gray"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,8"
                                       IsVisible="{Binding HasNoTags}"/>
                            <ItemsControl x:Name="CategoriesItemsControl"
                                         ItemsSource="{Binding CategoryViewModels}"
                                         IsVisible="{Binding HasTags}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="local:FilterCategoryViewModel">
                                        <StackPanel Margin="0,0,0,16">
                                            <!-- Category Header with Local Match Mode -->
                                            <Border Background="#2D2D30" Padding="8,6" Margin="0,0,0,8">
                                            <Grid ColumnDefinitions="Auto * Auto">
                                                <Button Grid.Column="0"
                                                       Content="{Binding ExpandIcon}"
                                                       Click="ToggleCategoryButton_Click"
                                                       CommandParameter="{Binding}"
                                                       Background="Transparent"
                                                       BorderThickness="0"
                                                       Padding="0"
                                                       Width="24"
                                                       Height="24"
                                                       Margin="0,0,8,0"
                                                       FontSize="14"/>
                                                <TextBlock Grid.Column="1"
                                                          Text="{Binding CategoryName}"
                                                          FontWeight="SemiBold"
                                                          FontSize="14"
                                                          VerticalAlignment="Center"/>
                                                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="8,0,0,0">
                                                    <TextBlock Text="Local:" VerticalAlignment="Center" FontSize="12"/>
                                                    <ComboBox Width="150" 
                                                             SelectedIndex="{Binding LocalMatchModeIndex}"
                                                             SelectionChanged="LocalMatchModeChanged"
                                                             Tag="{Binding}">
                                                        <ComboBoxItem Content="ALL (AND)"/>
                                                        <ComboBoxItem Content="ANY (OR)"/>
                                                    </ComboBox>
                                                </StackPanel>
                                            </Grid>
                                            </Border>

                                            <!-- Tags in this category -->
                                            <ItemsControl ItemsSource="{Binding Tags}" IsVisible="{Binding IsExpanded}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <UniformGrid Columns="3" Rows="0"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="local:FilterTagViewModel">
                                                        <Border Background="{Binding BackgroundBrush}"
                                                                CornerRadius="4"
                                                                Padding="8,6"
                                                                Margin="4">
                                                            <Grid ColumnDefinitions="* Auto Auto" ColumnSpacing="8">
                                                                <TextBlock Grid.Column="0"
                                                                          Text="{Binding Tag}"
                                                                          VerticalAlignment="Center"
                                                                          FontWeight="SemiBold"/>
                                                                <ToggleButton Grid.Column="1"
                                                                             Content="➕"
                                                                             IsChecked="{Binding IsPlusSelected}"
                                                                             Classes="IconToggleSmall"
                                                                             ToolTip.Tip="Include items with this tag"
                                                                             Click="PlusButton_Click"/>
                                                                <ToggleButton Grid.Column="2"
                                                                             Content="➖"
                                                                             IsChecked="{Binding IsMinusSelected}"
                                                                             Classes="IconToggleSmall"
                                                                             ToolTip.Tip="Exclude items with this tag"
                                                                             Click="MinusButton_Click"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Presets Tab -->
            <TabItem Header="Presets">
                <Grid RowDefinitions="Auto Auto *" Margin="12">
                    <!-- Choose Preset Section -->
                    <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,16">
                        <TextBlock Text="Choose Preset" 
                                   FontWeight="SemiBold" 
                                   FontSize="13"
                                   Margin="0,0,0,4"/>
                        <Grid ColumnDefinitions="* Auto" ColumnSpacing="8">
                            <ComboBox x:Name="PresetComboBox"
                                      Grid.Column="0"
                                      ItemsSource="{Binding PresetNames}"
                                      SelectedItem="{Binding SelectedPresetName}"
                                      SelectionChanged="PresetComboBox_SelectionChanged"/>
                            <Button Grid.Column="1"
                                    Content="Update Preset"
                                    Click="UpdatePresetButton_Click"
                                    IsEnabled="{Binding CanUpdatePreset}"
                                    MinWidth="100"
                                    ToolTip.Tip="Save current filter settings to the selected preset"/>
                        </Grid>
                    </StackPanel>

                    <!-- Create New Preset Section -->
                    <StackPanel Grid.Row="1" Spacing="8" Margin="0,0,0,16">
                        <TextBlock Text="Create New Preset From Current Filter Settings" 
                                   FontWeight="SemiBold" 
                                   FontSize="13"
                                   Margin="0,0,0,4"/>
                        <Grid ColumnDefinitions="* Auto" ColumnSpacing="8">
                            <TextBox x:Name="NewPresetNameTextBox"
                                     Grid.Column="0"
                                     Watermark="Enter preset name"
                                     KeyDown="NewPresetNameTextBox_KeyDown"/>
                            <Button Grid.Column="1"
                                    Content="Add Preset"
                                    Click="AddPresetButton_Click"
                                    MinWidth="100"/>
                        </Grid>
                    </StackPanel>

                    <!-- Manage Presets Section -->
                    <StackPanel Grid.Row="2" Spacing="8" VerticalAlignment="Stretch">
                        <TextBlock Text="Manage Presets" 
                                   FontWeight="SemiBold" 
                                   FontSize="13"
                                   Margin="0,0,0,4"/>
                        <Border BorderBrush="{DynamicResource ThemeBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="8"
                                VerticalAlignment="Stretch">
                            <ListBox x:Name="PresetsListBox"
                                     ItemsSource="{Binding Presets}"
                                     VerticalAlignment="Stretch">
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:DataType="local:FilterPreset">
                                        <Grid ColumnDefinitions="* Auto Auto Auto Auto" 
                                              ColumnSpacing="4" 
                                              Margin="0,2">
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding Name}"
                                                       VerticalAlignment="Center"
                                                       Margin="4,0"/>
                                            <Button Grid.Column="1"
                                                    Content="↑"
                                                    Click="MovePresetUpButton_Click"
                                                    Tag="{Binding}"
                                                    ToolTip.Tip="Move up"
                                                    Width="30"
                                                    Margin="2,0"/>
                                            <Button Grid.Column="2"
                                                    Content="↓"
                                                    Click="MovePresetDownButton_Click"
                                                    Tag="{Binding}"
                                                    ToolTip.Tip="Move down"
                                                    Width="30"
                                                    Margin="2,0"/>
                                            <Button Grid.Column="3"
                                                    Content="Rename"
                                                    Click="RenamePresetButton_Click"
                                                    Tag="{Binding}"
                                                    MinWidth="60"
                                                    Margin="2,0"/>
                                            <Button Grid.Column="4"
                                                    Content="Delete"
                                                    Click="DeletePresetButton_Click"
                                                    Tag="{Binding}"
                                                    MinWidth="60"
                                                    Margin="2,0"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </StackPanel>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Buttons -->
        <StackPanel Grid.Row="2" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right"
                    Spacing="8">
            <Button Content="Clear all filters"
                    Click="ClearAllButton_Click"
                    MinWidth="120"/>
            <Button Content="Cancel"
                    Click="CancelButton_Click"
                    MinWidth="100"/>
            <Button Content="Apply"
                    Click="ApplyButton_Click"
                    MinWidth="100"
                    IsDefault="True"/>
        </StackPanel>
    </Grid>
</Window>
