# Changelog

## Unreleased

- **Major: Library Refactor - Transform to library-based system**:
  - Replace folder-based model with persistent library system using `library.json`
  - New unified Library panel replaces separate Favorites, Blacklist, and Recently Played panels
  - Add Library Sources: Import and manage multiple folder sources, enable/disable individual sources
  - Add Tags system: Create and manage tags, assign tags to individual videos, filter by tags (AND/OR logic)
  - Add unified FilterDialog: Single source of truth for all filtering (favorites, blacklist, audio, duration, tags, playback status)
  - Add Library Info Row: Display library statistics and quick access to filter configuration
  - Consolidate data storage: Merge favorites, blacklist, durations, playback stats, loudness stats, and history into `library.json`
  - Consolidate settings: Merge playback settings, view preferences, and filter state into `settings.json`
  - Add one-time data migration: Automatically migrate existing data from legacy JSON files into new library structure
  - Update random playback: Now uses library system with filter state instead of folder scanning
  - Update stats panel: Now calculates from library data, includes tags display for current video
  - Performance improvements: Async library info calculation to prevent UI blocking, optimized filtering operations
  - Remove legacy UI: Old panel toggles, folder selection row, and separate filter controls removed
- **Add comprehensive logging system**:
  - Unified logging: All application logging consolidated into single `last.log` file in AppData directory
  - Logging coverage: Added detailed logging across all major operations:
    - Application startup and initialization
    - Media playback operations (play, pause, stop, seek, volume changes)
    - Library operations (load, save, import, updates)
    - Scanning operations (duration and loudness scans)
    - UI event handlers (button clicks, menu actions, user interactions)
    - File and folder operations
    - Error handling and exception logging
    - State changes (filter updates, queue rebuilds, settings saves)
  - Timestamped entries: All log entries include precise timestamps for debugging
  - Log rotation: `last.log` is overwritten on each application run for easy access to latest session
- **Add audio statistics and scan status improvements**:
  - Distinguish between "no audio" videos (successful scan) and genuine errors during loudness scanning
  - Add separate counters for no-audio files vs errors in scan status messages
  - Improve scan progress updates: update every file with throttling (max once per 100ms) instead of every 50 files
  - Add `HasAudio` property to loudness metadata to track audio presence
  - Add backward compatibility handling for existing loudness stats without `HasAudio` field
  - Fix: Videos with -91.0 dB loudness (placeholder value) now correctly marked as no-audio
  - Add global audio statistics: "Videos with audio" and "Videos without audio" counts in Stats panel
  - Add current video audio stats: "Has audio" status and loudness/peak dB values in Stats panel
- **Add audio filter mode for playback**:
  - New filter modes: Play all, Only with audio, Only without audio
  - Audio filter settings moved to Playback menu
  - Filter persists in playback settings and applies to random/queue selection
  - Direct play actions (favorites, blacklist, etc.) always work regardless of filter mode
- **Improve volume normalization algorithm**:
  - Increase target loudness from -18.0 dB to -16.0 dB for better perceived volume
  - Increase max gain adjustment from ±12.0 dB to ±20.0 dB for very quiet videos
  - Add peak-based limiter to prevent loud videos from exceeding -3.0 dB (prevents clipping/distortion)
  - Use PeakDb data to inform limiting decisions alongside MeanVolumeDb
  - Refactor normalization calculation into single helper method for consistency
- **Add FFmpeg logging window**:
  - New "Show FFmpeg logs" option in View menu
  - Displays detailed FFmpeg execution logs (exit codes, output, results) in separate non-modal window
  - Includes Copy Logs and Clear buttons for debugging loudness scanning issues
  - Auto-refreshes every 2 seconds to show new logs during scanning
- **UI improvements**:
  - Remove "(all libraries)" suffix from global stats labels for cleaner display
  - Add peak dB display to current video stats in Stats panel
- **Add volume normalization system** with four modes:
  - Off: No normalization (direct volume control)
  - Simple: Real-time normalization using LibVLC `normvol` audio filter only
  - Library-aware: Per-file loudness adjustment only (no real-time filter)
  - Advanced: Both per-file loudness adjustment and real-time normalization
- Add loudness scanning feature: scan video library to measure mean volume and peak levels per file
- Add persistent loudness statistics storage (loudnessStats.json)
- Add volume normalization menu controls in Playback menu
- Add "Scan loudness…" option in Library menu for per-file loudness analysis
- Extend NativeBinaryHelper with GetFFmpegPath() for loudness scanning
- Library-aware and Advanced modes automatically adjust volume per-file based on scanned loudness data
- Fix: Switching normalization modes during playback now properly recreates media with correct options
- Fix: Mute button now correctly preserves user volume preference instead of normalized volume value
- **Improve duration scanning reliability**:
  - Replace TagLib# duration scanning with FFprobe for significantly improved reliability (works on virtually all video formats)
  - Fix thread-safety issues in semaphore initialization and permit leak in duration scanning
- **Bundle native dependencies**:
  - Bundle FFprobe and LibVLC native libraries to eliminate external dependencies
  - Add NativeBinaryHelper for platform-aware binary path resolution with caching
  - Add license attribution for bundled third-party components (GPL-3.0, LGPL-2.1)
- **Performance improvements**:
  - Move loop restart work off the UI thread to reduce freezes when videos restart
